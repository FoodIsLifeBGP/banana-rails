FROM rubylang/ruby:2.6.3-bionic
RUN apt-get update -qq && apt-get -y install postgresql-client libpq5 libpq-dev wget
RUN mkdir /banana-rails
WORKDIR /banana-rails

# gem install
COPY Gemfile /banana-rails/Gemfile
COPY Gemfile.lock /banana-rails/Gemfile.lock
RUN bundle install
RUN gem install pg -v '1.1.4' --source 'https://rubygems.org/'

COPY . /banana-rails
RUN wget https://github.com/jwilder/dockerize/releases/download/v0.6.1/dockerize-linux-amd64-v0.6.1.tar.gz
RUN tar -C /usr/local/bin -xzvf dockerize-linux-amd64-v0.6.1.tar.gz
RUN dockerize -wait tcp://localhost:5432 -timeout 1m

# Run the tests
CMD ["rails", "test"]
